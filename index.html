<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ncore 연차관리</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/ko.min.js"></script>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap');
    body { font-family: 'Noto Sans KR', sans-serif; }
    .fade-in { animation: fadeIn 0.3s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background-color: #e5e7eb; }
    .calendar-cell { background-color: white; min-height: 140px; padding: 4px; position: relative; }
    .calendar-header-cell { background-color: #f9fafb; padding: 12px; text-align: center; font-weight: bold; color: #4b5563; font-size: 0.95rem; }
    .holiday-text { color: #ef4444 !important; }
    .sat-text { color: #3b82f6 !important; }
    #loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:9999; display:flex; justify-content:center; align-items:center; flex-direction:column; }
    .today-circle { background-color: #4f46e5; color: white; border-radius: 50%; width: 24px; height: 24px; display: inline-flex; align-items: center; justify-content: center; }
    .custom-scrollbar::-webkit-scrollbar { width: 4px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
    .custom-scrollbar::-webkit-scrollbar-track { background-color: transparent; }
    #custom-tooltip { position: fixed; background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); z-index: 9999; pointer-events: none; display: none; min-width: 200px; max-width: 300px; font-size: 0.85rem; }
</style>
<script>
    window.onerror = function(msg, url, line) {
        alert("시스템 오류 발생: " + msg + "\n줄 번호: " + line);
        document.getElementById('loading-overlay').style.display = 'none';
        return false;
    };
</script>
</head>
<body class="bg-gray-50 text-gray-800">

<div id="loading-overlay">
    <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-indigo-600 mb-4"></div>
    <p class="text-indigo-800 font-bold text-xl" id="loading-text">Ncore 서버 연결 중...</p>
</div>

<div id="custom-tooltip"></div>

<nav class="bg-white shadow-md fixed w-full z-20 top-0">
    <div class="max-w-7xl mx-auto px-6">
        <div class="flex justify-between h-16">
            <div class="flex items-center cursor-pointer" onclick="app.refreshDashboard()">
                <i class="fa-solid fa-cloud text-indigo-600 text-2xl mr-2"></i>
                <span class="font-bold text-xl text-gray-900">Ncore 연차관리</span>
            </div>
            <div class="flex items-center space-x-4" id="nav-info"></div>
        </div>
    </div>
</nav>

<main id="app-container" class="pt-24 pb-12 min-h-screen"></main>

<script>
    // ★ 최신 URL 적용됨
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyCFXnBB9_PsAF2Ih_w8cLprfr-ICnwa-AMXkXcC89dV9ZK2CjRDkZ6v1O-M34HvR4r/exec";

    const initialAdmin = { 
        users: [
            { id: 'master', password: '1', name: '최고관리자', role: 'master', dept: 'SYSTEM', rank: '관리자', totalHours: 0, usedHours: 0, email: '' },
            { id: 'ceo', password: '1', name: '대표이사', role: 'ceo', dept: '임원', rank: '대표', totalHours: 0, usedHours: 0, email: '' }
        ],
        requests: [] 
    };

    const appData = { users: [], requests: [], holidays: {} };

    // ★★★ [아웃룩 연동] 메일 쓰기 창 띄우기 함수 ★★★
    function openOutlookDraft(to, subject, body) {
        if (!to) return;
        const mailtoLink = `mailto:${to}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        
        const link = document.createElement('a');
        link.href = mailtoLink;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    const db = {
        init: async () => { await db.load(); },
        load: async () => {
            try {
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=load`);
                const json = await response.json();
                if (json.result === 'success') {
                    appData.users = json.data.users && json.data.users.length > 0 ? json.data.users : initialAdmin.users;
                    appData.requests = json.data.requests || [];
                    appData.holidays = json.data.holidays || {};
                }
            } catch (e) { console.error(e); } finally { document.getElementById('loading-overlay').style.display = 'none'; }
        },
        save: async (showLoading = true) => { 
            app.recalcUsedHours();
            if(showLoading) {
                document.getElementById('loading-text').innerText = "데이터 저장 중...";
                document.getElementById('loading-overlay').style.display = 'flex';
            }
            try {
                await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'save', 
                        users: appData.users, 
                        requests: appData.requests
                    })
                });
            } catch (e) { alert("저장 오류"); } finally { if(showLoading) document.getElementById('loading-overlay').style.display = 'none'; }
        }
    };

    const holidayLogic = {
        isRedDay: (dateStr) => { 
            const d = new Date(dateStr); 
            const formatted = moment(dateStr).format('YYYY-MM-DD'); 
            const holName = appData.holidays ? appData.holidays[formatted] : null; 
            return d.getDay() === 0 || !!holName; 
        },
        getHolName: (dateStr) => {
            const formatted = moment(dateStr).format('YYYY-MM-DD'); 
            return appData.holidays ? appData.holidays[formatted] : null;
        },
        isSat: (dateStr) => new Date(dateStr).getDay() === 6,
        calcBizDays: (s, e) => {
            let cnt = 0, cur = moment(s), end = moment(e);
            while(cur.isSameOrBefore(end)){
                const ds = cur.format('YYYY-MM-DD');
                if(!holidayLogic.isRedDay(ds) && !holidayLogic.isSat(ds)) cnt++;
                cur.add(1,'d');
            } return cnt;
        }
    };

    const timeLogic = {
        getEff: (s,e) => { let c=0; for(let i=s;i<e;i++) if(i!==12) c++; return c; },
        calcStart: (d,e) => { let n=d, c=e; while(n>0){ c--; if(c!==12) n--; } return c; }
    };

    function makeTimeOptions() {
        let options = '';
        for(let i=7; i<=17; i++) {
            const val = i < 10 ? '0' + i : i;
            options += `<option value="${i}">${val}:00</option>`;
        }
        return options;
    }

    const app = {
        currentUser: null,
        editingId: null,
        viewYear: new Date().getFullYear(),
        viewMonth: new Date().getMonth(),
        showPastShading: true, 

        init: async () => { 
            try { await db.init(); app.renderLogin(); } catch(e) { alert("초기화 오류: " + e.message); }
        },

        renderLogin: () => {
            document.getElementById('app-container').innerHTML = `<div class="flex flex-col items-center justify-center h-[calc(100vh-160px)] px-4"><div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm border border-gray-100"><div class="text-center mb-8"><i class="fa-solid fa-cloud text-indigo-600 text-5xl mb-4"></i><h1 class="text-2xl font-bold text-gray-800">Ncore 연차관리</h1></div><div class="space-y-4"><div><label class="block text-xs font-bold text-gray-500 mb-1 ml-1">아이디</label><input id="login-id" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-lg focus:outline-none focus:border-indigo-500" placeholder="ID 입력"></div><div><label class="block text-xs font-bold text-gray-500 mb-1 ml-1">비밀번호</label><input type="password" id="login-pw" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-lg focus:outline-none focus:border-indigo-500" placeholder="비밀번호 입력"></div><button onclick="app.tryLogin()" class="w-full bg-indigo-600 text-white font-bold py-3.5 rounded-lg hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition mt-2">로그인</button></div></div></div>`;
        },

        renderNav: () => {
            const el = document.getElementById('nav-info');
            if (!app.currentUser) return el.innerHTML = '';
            el.innerHTML = `<div class="flex items-center"><div class="text-right mr-3"><p class="text-sm font-bold">${app.currentUser.name} <span class="text-xs text-gray-500">${app.currentUser.rank||''}</span>${app.currentUser.role==='master'?'<span class="text-[10px] bg-red-600 text-white px-1 rounded ml-1">MASTER</span>':''}</p><p class="text-xs text-gray-500">${app.currentUser.dept}</p></div>${['master','ceo','manager'].includes(app.currentUser.role)?`<button onclick="app.renderUserManagement()" class="mr-2 text-sm bg-indigo-600 text-white px-3 py-2 rounded-lg font-bold">구성원 관리</button>`:''}<button onclick="document.getElementById('pw-modal').classList.remove('hidden')" class="mr-2 text-sm bg-white border px-3 py-2 rounded-lg">비번변경</button><button onclick="app.logout()" class="text-sm bg-gray-800 text-white px-4 py-2 rounded-lg font-bold">로그아웃</button></div>`;
        },

        recalcUsedHours: () => {
            appData.users.forEach(u => u.usedHours = 0);
            appData.requests.forEach(r => {
                if (r.status === 'approved') {
                    const u = appData.users.find(user => String(user.id) === String(r.userId));
                    if (u) u.usedHours += r.hours;
                }
            });
        },

        tryLogin: () => {
            const id = document.getElementById('login-id').value;
            const pw = document.getElementById('login-pw').value;
            const user = appData.users.find(u => String(u.id) === String(id) && String(u.password) === String(pw)); 
            if (user) { 
                app.currentUser = user; 
                app.recalcUsedHours(); 
                app.renderNav(); 
                app.refreshDashboard(); 
            } else { alert('아이디/비번 확인'); }
        },

        logout: () => { if(confirm('로그아웃 하시겠습니까?')) { app.currentUser = null; app.renderNav(); app.renderLogin(); } },

        changePassword: async () => {
            const curPw = document.getElementById('pw-current').value;
            const newPw = document.getElementById('pw-new').value;
            const cfmPw = document.getElementById('pw-confirm').value;
            if(String(curPw) !== String(app.currentUser.password)) return alert('현재 비밀번호 불일치');
            if(!newPw || newPw !== cfmPw) return alert('새 비밀번호 확인 필요');
            const userIdx = appData.users.findIndex(u => u.id === app.currentUser.id);
            appData.users[userIdx].password = newPw;
            app.currentUser.password = newPw;
            await db.save(); alert('변경되었습니다.'); document.getElementById('pw-modal').classList.add('hidden');
        },

        refreshDashboard: () => {
            if(!app.currentUser) return app.renderLogin();
            if(['ceo', 'manager', 'master'].includes(app.currentUser.role)) app.renderManagerDashboard();
            else app.renderEmployeeDashboard();
        },

        changeMonth: (offset) => {
            app.viewMonth += offset;
            if(app.viewMonth > 11) { app.viewMonth = 0; app.viewYear++; }
            else if(app.viewMonth < 0) { app.viewMonth = 11; app.viewYear--; }
            app.refreshDashboard();
        },

        togglePastShading: () => { app.showPastShading = !app.showPastShading; app.refreshDashboard(); },

        showTooltip: (dateStr, event) => {
            const tooltip = document.getElementById('custom-tooltip');
            const reqs = appData.requests.filter(r => r.status === 'approved' || r.status === 'cancel_requested');
            const daysEvents = reqs.filter(r => moment(dateStr).isBetween(r.startDate, r.endDate, 'day', '[]'));
            if(daysEvents.length === 0) return;
            
            const typePriority = { '연차': 1, '반차': 2, '조퇴': 3, '외출': 4 };
            daysEvents.sort((a, b) => {
                const pA = typePriority[a.type] || 99;
                const pB = typePriority[b.type] || 99;
                if (pA !== pB) return pA - pB;
                return a.userName.localeCompare(b.userName, 'ko');
            });

            let html = `<div class="font-bold border-b pb-1 mb-2 text-gray-700">${moment(dateStr).format('M월 D일')} 일정</div>`;
            daysEvents.forEach(e => {
                const displayType = (e.type === '시간차') ? '조퇴' : e.type;
                let detail = '';
                if (displayType === '조퇴' || displayType === '외출') detail = ` <span class="text-xs text-gray-500">(${e.timeRange} / ${e.hours}h)</span>`;
                const reason = e.reason ? `<div class="text-xs text-gray-400 pl-1">└ ${e.reason}</div>` : '';
                html += `<div class="mb-1.5 last:mb-0"><span class="font-bold text-gray-800">${e.userName}</span><span class="text-xs px-1.5 py-0.5 rounded bg-gray-100 text-gray-600 ml-1">${displayType}</span>${detail}${reason}</div>`;
            });
            tooltip.innerHTML = html; tooltip.style.display = 'block'; app.moveTooltip(event);
        },

        moveTooltip: (event) => {
            const tooltip = document.getElementById('custom-tooltip');
            const x = event.clientX + 15;
            const y = event.clientY + 15;
            const rightOverflow = x + tooltip.offsetWidth > window.innerWidth;
            const bottomOverflow = y + tooltip.offsetHeight > window.innerHeight;
            tooltip.style.left = rightOverflow ? (event.clientX - tooltip.offsetWidth - 10) + 'px' : x + 'px';
            tooltip.style.top = bottomOverflow ? (event.clientY - tooltip.offsetHeight - 10) + 'px' : y + 'px';
        },

        hideTooltip: () => { document.getElementById('custom-tooltip').style.display = 'none'; },

        approveAll: async (type) => {
            const u = app.currentUser;
            const isM = u.role === 'master';
            const targets = appData.requests.filter(r => {
                if (type === 'pending' && r.status !== 'pending') return false;
                if (type === 'cancel' && r.status !== 'cancel_requested') return false;
                if (isM) return true;
                if (u.role === 'ceo') return r.role !== 'ceo'; 
                if (u.role === 'manager') return r.dept === u.dept && r.role === 'employee';
                return false;
            });
            if (targets.length === 0) return alert('처리할 내역이 없습니다.');
            const msg = type === 'pending' ? '승인' : '취소 승인';
            if (!confirm(`총 ${targets.length}건을 일괄 ${msg} 하시겠습니까?`)) return;
            
            targets.forEach(r => {
                if (type === 'pending') r.status = 'approved';
                else if (type === 'cancel') r.status = 'cancelled';
            });
            await db.save(); app.refreshDashboard();
        },

        editReq: (id) => {
            const req = appData.requests.find(r => r.id === id);
            if (!req) return;
            if (req.status !== 'pending') return alert('대기 상태인 항목만 수정 가능합니다.');
            app.editingId = id; 
            document.getElementById('req-type').value = req.type;
            document.getElementById('req-start-date').value = req.startDate;
            document.getElementById('req-end-date').value = req.endDate;
            document.getElementById('req-reason').value = req.reason;
            const isMulti = req.startDate !== req.endDate;
            document.getElementById('is-multi-day').checked = isMulti;
            if (req.type === '조퇴' || req.type === '외출') {
                const parts = req.timeRange.split('~');
                if(parts.length === 2) {
                    const startH = parseInt(parts[0]);
                    const endH = parseInt(parts[1]);
                    if(req.type === '조퇴') {
                        document.getElementById('req-duration-timeoff').value = req.hours;
                        document.getElementById('req-end-time-timeoff').value = endH;
                    } else {
                        document.getElementById('req-start-time-out').value = startH;
                        document.getElementById('req-end-time-out').value = endH;
                    }
                }
            }
            toggleInputs();
            document.getElementById('req-modal-title').innerText = "연차 수정";
            document.getElementById('req-modal-btn').innerText = "수정 완료";
            document.getElementById('req-modal').classList.remove('hidden');
        },

        submitRequest: async () => {
            const type = document.getElementById('req-type').value;
            const sDate = document.getElementById('req-start-date').value;
            const isMultiDay = document.getElementById('is-multi-day').checked;
            let eDate = isMultiDay ? document.getElementById('req-end-date').value : sDate;
            const reason = document.getElementById('req-reason').value;
            if(!sDate) return alert('날짜를 선택하세요');
            
            let hours = 0, timeRange = '';
            
            if(type==='연차') {
                const days = holidayLogic.calcBizDays(sDate, eDate);
                if(days===0) return alert('선택하신 기간은 모두 휴일입니다.');
                hours = days*8;
            } else if(type==='반차') hours = 4;
            else if(type==='조퇴') {
                const d = parseInt(document.getElementById('req-duration-timeoff').value);
                const e = parseInt(document.getElementById('req-end-time-timeoff').value);
                hours = d; timeRange = `${timeLogic.calcStart(d,e)}:00~${e}:00`;
            } else { 
                const s = parseInt(document.getElementById('req-start-time-out').value);
                const e = parseInt(document.getElementById('req-end-time-out').value);
                if(s>=e) return alert('시간 설정 오류');
                hours = timeLogic.getEff(s,e); timeRange = `${s}:00~${e}:00`;
            }
            
            const remaining = app.currentUser.totalHours - app.currentUser.usedHours;

            if (app.editingId) {
                const idx = appData.requests.findIndex(r => r.id === app.editingId);
                if (idx !== -1) {
                    appData.requests[idx] = {
                        ...appData.requests[idx],
                        type, startDate: sDate, endDate: eDate, hours, timeRange: timeRange || '', reason,
                        timestamp: new Date().toISOString()
                    };
                    alert('수정되었습니다.');
                }
                await db.save(); 
            } else {
                if (hours > remaining) return alert(`잔여 연차 부족`);
                
                const newReq = {
                    id: Date.now(), userId: app.currentUser.id, userName: app.currentUser.name,
                    dept: app.currentUser.dept, role: app.currentUser.role, type, startDate: sDate, endDate: eDate,
                    hours, timeRange: timeRange || '', reason, status: ['ceo', 'master'].includes(app.currentUser.role) ? 'approved' : 'pending',
                    timestamp: new Date().toISOString()
                };
                appData.requests.push(newReq);
                
                await db.save();

                // ★★★ [수정됨] 사용자 요청 메일 내용 반영
                let recipientName = "";
                if (app.currentUser.dept === '매뉴얼팀') recipientName = '이동진';
                else if (app.currentUser.dept === '파츠북팀') recipientName = '박진형';
                else recipientName = '최고관리자';

                let targetAdmin = appData.users.find(u => u.name === recipientName);
                let targetEmail = (targetAdmin && targetAdmin.email) ? targetAdmin.email : "";

                if(targetEmail) {
                    const subject = `[연차신청] ${app.currentUser.name} - ${type}`;
                    // ★ 여기를 요청하신 내용으로 변경했습니다
                    const body = `연차신청이 왔습니다. 확인부탁드립니다.\n\n접속주소: https://ncore-comp.github.io/ncore-vacation/\n\n[신청 내용]\n- 이름: ${app.currentUser.name}\n- 종류: ${type}\n- 기간: ${sDate} ~ ${eDate} ${timeRange ? '('+timeRange+')' : ''}\n- 사유: ${reason}`;
                    
                    openOutlookDraft(targetEmail, subject, body);
                    alert('데이터 저장 완료. 아웃룩 창이 뜨면 [보내기]를 눌러주세요.');
                } else {
                    alert('저장되었습니다. (담당자 메일 주소 없음)');
                }
            }
            
            document.getElementById('req-modal').classList.add('hidden'); 
            app.refreshDashboard();
        },

        processReq: async (id, action) => {
            const req = appData.requests.find(r=>r.id===id);
            if(!req) return;
            
            let mailType = '';
            if(action === 'approve') { req.status = 'approved'; mailType = '승인'; }
            else if(action === 'reject') { req.status = 'rejected'; mailType = '반려'; }
            else if(action === 'cancel_req') {
                if(!confirm('취소하시겠습니까?')) return;
                req.status = req.status==='pending' ? 'cancelled' : 'cancel_requested';
            } 
            else if(action === 'cancel_approve') { req.status = 'cancelled'; mailType = '취소승인'; }
            else if(action === 'cancel_reject') { req.status = 'approved'; }

            await db.save();

            let targetUser = appData.users.find(u => String(u.id) === String(req.userId));
            if (mailType && targetUser && targetUser.email) {
                const subject = `[연차${mailType}] 신청하신 연차가 ${mailType}되었습니다.`;
                const body = `${targetUser.name}님,\n\n신청하신 연차가 관리자에 의해 [${mailType}] 처리되었습니다.\n\n- 종류: ${req.type}\n- 기간: ${req.startDate} ~ ${req.endDate}\n\n확인 부탁드립니다.\n접속주소: https://ncore-comp.github.io/ncore-vacation/`;
                
                openOutlookDraft(targetUser.email, subject, body);
                alert(`처리되었습니다. 아웃룩 창이 뜨면 [보내기]를 눌러주세요.`);
            } else {
                if(mailType) alert('처리되었습니다. (메일 발송 안함: 이메일 없음)');
                else app.refreshDashboard();
            }

            app.refreshDashboard();
        },

        deleteReq: async (id) => {
            if(!confirm('내역을 영구 삭제하시겠습니까?')) return;
            appData.requests = appData.requests.filter(r => r.id !== id);
            await db.save(); app.refreshDashboard();
        },

        addUser: async () => {
            const vals = ['new-id','new-pw','new-name','new-role','new-dept','new-rank','new-days', 'new-email'].map(i=>document.getElementById(i).value.trim());
            if(!vals[0] || !vals[2]) return alert('필수 입력 누락');
            if(appData.users.some(u => String(u.id) === vals[0])) return alert('이미 존재하는 ID입니다.');
            appData.users.push({ 
                id:vals[0], password:vals[1] || '1', name:vals[2], role:vals[3], 
                dept:vals[4], rank:vals[5], totalHours:parseInt(vals[6]||15)*8, usedHours:0,
                email: vals[7] 
            });
            await db.save(); app.renderUserManagement();
        },

        setEditMode: (id) => { app.editingId = id; app.renderUserManagement(); },
        cancelEdit: () => { app.editingId = null; app.renderUserManagement(); },

        updateUser: async (id) => {
            try {
                const u = appData.users.find(u => String(u.id) === String(id));
                if(!u) throw new Error('사용자 미확인');
                const nameInput = document.getElementById(`n-${id}`);
                const rankInput = document.getElementById(`r-${id}`);
                const daysInput = document.getElementById(`d-${id}`);
                const pwInput = document.getElementById(`p-${id}`); 
                const emailInput = document.getElementById(`e-${id}`); 
                if(nameInput) u.name = nameInput.value;
                if(rankInput) u.rank = rankInput.value;
                if(daysInput) {
                    const days = parseFloat(daysInput.value);
                    if (!isNaN(days)) u.totalHours = days * 8;
                }
                if(emailInput) u.email = emailInput.value;
                if(pwInput && pwInput.value.trim() !== '') u.password = pwInput.value.trim();
                await db.save(); alert('수정 완료');
            } catch (e) { console.error(e); alert('오류: ' + e.message); } finally { app.editingId = null; app.renderUserManagement(); }
        },

        deleteUser: async (id) => {
            if(!confirm('삭제하시겠습니까?')) return;
            appData.users = appData.users.filter(u => String(u.id) !== String(id));
            await db.save(); app.renderUserManagement();
        },

        togglePastDates: () => {
            const allowPast = document.getElementById('allow-past')?.checked;
            const sDate = document.getElementById('req-start-date');
            const eDate = document.getElementById('req-end-date');
            const today = moment().format('YYYY-MM-DD');
            if(sDate) {
                if (allowPast) { sDate.removeAttribute('min'); if(eDate) eDate.removeAttribute('min'); }
                else { sDate.min = today; if(sDate.value && sDate.value < today) { sDate.value = today; if(eDate) eDate.value = today; } }
            }
        },
        fmtDate: (dateStr) => new Date(dateStr).toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'short' }),
        fmtTime: function(h) { const d = Math.floor(h / 8), r = h % 8; if (d > 0) return r > 0 ? d + "일 " + r + "시간" : d + "일"; return r + "시간"; },

        renderCal: (requests, viewer) => {
            const year = app.viewYear, month = app.viewMonth, today = moment().startOf('day');
            const validRequests = requests.filter(r => !['cancelled', 'rejected'].includes(r.status));
            let viewReqs = viewer.role === 'master' ? validRequests : (viewer.role === 'ceo' ? validRequests.filter(r => r.status === 'approved' || r.status === 'cancel_requested' || ['manager', 'ceo'].includes(r.role)) : validRequests.filter(r => (r.dept === viewer.dept && ['approved', 'cancel_requested'].includes(r.status)) || r.userId === viewer.id));
            
            let html = `<div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 mb-6 flex justify-between items-center"><div class="flex items-center"><button onclick="app.changeMonth(-1)" class="w-10 h-10 rounded-full hover:bg-gray-100 flex items-center justify-center transition"><i class="fa-solid fa-chevron-left text-gray-600"></i></button><h3 class="text-2xl font-bold text-gray-800 mx-4">${year}년 ${month+1}월 <span class="text-base font-normal text-gray-500">(${viewer.dept})</span></h3><button onclick="app.changeMonth(1)" class="w-10 h-10 rounded-full hover:bg-gray-100 flex items-center justify-center transition"><i class="fa-solid fa-chevron-right text-gray-600"></i></button></div><div class="flex items-center"><label class="inline-flex items-center cursor-pointer"><input type="checkbox" ${app.showPastShading ? 'checked' : ''} onchange="app.togglePastShading()" class="sr-only peer"><div class="relative w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-gray-500"></div><span class="ms-2 text-xs font-medium text-gray-500">지난 날짜 음영</span></label></div></div><div class="calendar-grid border border-gray-200 rounded-lg overflow-hidden"><div class="calendar-header-cell text-red-500">일</div><div class="calendar-header-cell">월</div><div class="calendar-header-cell">화</div><div class="calendar-header-cell">수</div><div class="calendar-header-cell">목</div><div class="calendar-header-cell">금</div><div class="calendar-header-cell text-blue-500">토</div>`;
            const firstDayIdx = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();
            for(let i=0; i<firstDayIdx; i++) html += `<div class="calendar-cell bg-gray-50/50"></div>`;
            
            const typePriority = { '연차': 1, '반차': 2, '조퇴': 3, '외출': 4 };

            for(let d=1; d<=lastDate; d++) {
                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const curDate = moment(dateStr);
                const isToday = curDate.isSame(today, 'day');
                const isPast = curDate.isBefore(today, 'day');
                const applyShading = isPast && app.showPastShading;
                const evts = viewReqs.filter(r => curDate.isBetween(r.startDate, r.endDate, 'day', '[]'));
                evts.sort((a, b) => {
                    const pA = typePriority[a.type] || 99;
                    const pB = typePriority[b.type] || 99;
                    if (pA !== pB) return pA - pB;
                    return a.userName.localeCompare(b.userName, 'ko');
                });
                const isRed = holidayLogic.isRedDay(dateStr);
                const isSat = holidayLogic.isSat(dateStr);
                const holName = holidayLogic.getHolName(dateStr);
                
                let evtHtml = evts.map(e => {
                    const isMe = String(e.userId) === String(viewer.id);
                    const isCancel = e.status === 'cancel_requested';
                    let className = 'text-[10px] px-1 py-0.5 rounded mb-1 truncate border-l-4 '; 
                    if (isCancel) className += 'bg-white border-red-500 text-red-600 animate-pulse font-bold border-l';
                    else if (isMe) className += 'bg-indigo-600 text-white font-black border-indigo-800';
                    else {
                        if(e.type === '연차') className += 'bg-lime-200 text-lime-800 border-lime-600'; 
                        else if(e.type === '반차') className += 'bg-orange-100 text-orange-800 border-orange-500'; 
                        else if(e.type === '조퇴' || e.type === '시간차') className += 'bg-yellow-200 text-yellow-900 border-yellow-600'; 
                        else if(e.type === '외출') className += 'bg-stone-200 text-stone-800 border-stone-500'; 
                        else className += 'bg-gray-100 text-gray-700 border-gray-500';
                    }
                    const displayType = (e.type === '시간차') ? '조퇴' : e.type;
                    const label = `${e.userName}${displayType!=='연차'?`(${displayType})`:''}`;
                    return `<div class="${className}">${label}</div>`;
                }).join('');
                html += `<div class="calendar-cell hover:bg-gray-50 ${applyShading ? 'bg-gray-50' : ''}" onmouseenter="app.showTooltip('${dateStr}', event)" onmousemove="app.moveTooltip(event)" onmouseleave="app.hideTooltip()"><div class="flex justify-between items-start mb-1 ${applyShading ? 'opacity-40' : ''}"><span class="text-sm font-bold ml-1 mt-1 ${isToday?'today-circle':(isRed?'holiday-text':(isSat?'sat-text':'text-gray-700'))}">${d}</span>${holName ? `<span class="text-[10px] text-white bg-red-400 px-1 rounded truncate max-w-[60px]">${holName}</span>` : ''}</div><div class="grid grid-cols-2 gap-1 overflow-y-auto max-h-[100px] px-1 custom-scrollbar ${applyShading ? 'opacity-60 grayscale' : ''}">${evtHtml}</div></div>`;
            }
            return html + `</div>`;
        },
        renderEmployeeDashboard: () => {
            const u = app.currentUser, reqs = appData.requests.filter(r=>r.userId===u.id).sort((a,b)=>b.id-a.id);
            document.getElementById('app-container').innerHTML = `<div class="w-full max-w-7xl mx-auto px-4 fade-in"><div class="bg-white p-6 rounded-2xl shadow-sm border mb-8 flex justify-between items-center"><div class="absolute left-0 top-0 w-1.5 h-full bg-indigo-500"></div><div><h2 class="text-2xl font-bold">내 연차 현황</h2><p class="text-sm text-gray-500 mt-1">${u.dept} | 총 ${app.fmtTime(u.totalHours)}</p></div><div class="text-right"><p class="text-xs text-gray-400 font-bold mb-1">남은 연차</p><div class="text-4xl font-bold text-indigo-600">${app.fmtTime(u.totalHours-u.usedHours)} <span class="text-lg text-gray-400 font-normal">/ ${app.fmtTime(u.totalHours)}</span></div></div></div><div class="mb-10">${app.renderCal(appData.requests, u)}</div><div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold">최근 신청 내역</h3><button onclick="document.getElementById('req-modal').classList.remove('hidden'); app.initModal();" class="bg-indigo-600 text-white px-6 py-2.5 rounded-lg font-bold shadow-md shadow-indigo-200"><i class="fa-solid fa-plus mr-2"></i> 연차 신청</button></div><div class="bg-white rounded-xl shadow-sm border overflow-hidden">${reqs.length===0?'<div class="p-8 text-center text-gray-400">내역 없음</div>':reqs.map(r=> {
                const displayType = (r.type === '시간차') ? '조퇴' : r.type;
                let badgeClass = '';
                if(displayType === '연차') badgeClass = 'bg-lime-200 text-lime-900';
                else if(displayType === '반차') badgeClass = 'bg-orange-100 text-orange-800';
                else if(displayType === '조퇴' || r.type === '시간차') badgeClass = 'bg-yellow-200 text-yellow-900';
                else if(displayType === '외출') badgeClass = 'bg-stone-200 text-stone-800';
                else badgeClass = 'bg-gray-100 text-gray-700';
                const cancelBtnText = r.status === 'pending' ? '취소' : '취소 요청';
                return `<div class="p-5 border-b last:border-0 hover:bg-gray-50 flex justify-between items-center"><div class="flex-grow"><div class="flex items-center space-x-2 mb-1"><span class="px-2 py-0.5 rounded text-xs font-bold ${badgeClass}">${displayType}</span><span class="font-bold text-lg">${r.startDate===r.endDate?app.fmtDate(r.startDate):app.fmtDate(r.startDate)+'~'+app.fmtDate(r.endDate)}</span>${r.timeRange?`<span class="text-sm font-bold text-gray-500 bg-gray-100 px-2 rounded ml-2">(${r.timeRange})</span>`:''}</div><p class="text-sm text-gray-500 pl-1"><span class="font-medium text-gray-700">${r.reason}</span> | <span class="text-gray-400">${r.hours}h 차감</span></p></div><div class="flex flex-col items-end min-w-[80px]"><span class="font-bold px-3 py-1 rounded-full text-xs text-center ml-auto mb-1 ${r.status==='approved'?'bg-green-100 text-green-700':(r.status==='rejected'?'bg-red-100 text-red-700':(r.status==='pending'?'bg-yellow-100 text-yellow-700':'bg-gray-200 text-gray-500'))}">${r.status==='pending'?'승인 대기':(r.status==='approved'?'승인 완료':(r.status==='rejected'?'반려됨':(r.status==='cancel_requested'?'취소 요청중':'취소됨')))}</span>${r.status==='pending'?`<button onclick="app.editReq(${r.id})" class="text-xs text-indigo-500 underline hover:text-indigo-700 font-bold text-right mb-1 pr-3">수정</button>`:''}${['pending','approved'].includes(r.status)?`<button onclick="app.processReq(${r.id},'cancel_req')" class="text-xs text-gray-400 underline hover:text-red-500 text-right pr-3">${cancelBtnText}</button>`:''}${['cancelled','rejected'].includes(r.status)?`<button onclick="app.deleteReq(${r.id})" class="text-xs text-gray-400 underline hover:text-red-600 text-right pr-3"><i class="fa-regular fa-trash-can mr-1"></i>삭제</button>`:''}</div></div>`;
            }).join('')}</div></div>${app.getModal()}`;
            app.initModal();
        },
        renderManagerDashboard: () => {
            const u = app.currentUser, isM = u.role === 'master', isCEO = u.role === 'ceo';
            const pendings = appData.requests.filter(r => (['pending', 'cancel_requested'].includes(r.status)) && (isM ? true : (app.currentUser.role==='ceo' ? (r.role!=='ceo') : (r.dept===app.currentUser.dept && r.role==='employee'))));
            let allMembers = (isM || app.currentUser.role === 'ceo') ? appData.users.filter(u => ['employee', 'manager'].includes(u.role)) : appData.users.filter(u => u.dept === app.currentUser.dept && u.id !== app.currentUser.id);
            const departments = [...new Set(allMembers.map(u => u.dept))].sort();
            let memberStatusHtml = allMembers.length > 0 ? departments.map(deptName => {
                const deptMembers = allMembers.filter(u => u.dept === deptName).sort((a,b)=>a.name.localeCompare(b.name));
                let bgStyle = 'bg-gray-50 border-gray-200', titleColor = 'text-gray-800', iconColor = 'text-gray-500';
                if(deptName === '매뉴얼팀') { bgStyle = 'bg-indigo-50 border-indigo-100'; titleColor = 'text-indigo-800'; iconColor = 'text-indigo-600'; }
                else if (deptName === '파츠북팀') { bgStyle = 'bg-emerald-50 border-emerald-100'; titleColor = 'text-emerald-800'; iconColor = 'text-emerald-600'; }
                return `<div class="${bgStyle} p-5 rounded-xl shadow-sm border mb-8"><h3 class="font-bold ${titleColor} mb-4 flex items-center"><i class="fa-solid fa-users mr-2 ${iconColor}"></i> 팀원 연차 현황 / ${deptName}</h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">${deptMembers.map(m => `<div class="bg-white border border-white/50 rounded-lg p-3 flex justify-between items-center shadow-sm hover:shadow-md transition"><div><div class="font-bold text-gray-800">${m.name} <span class="text-xs text-gray-500">(${m.rank||''})</span></div></div><div class="text-right"><div class="text-sm font-bold ${m.totalHours-m.usedHours<0?'text-red-600':'text-indigo-600'}">${app.fmtTime(m.totalHours-m.usedHours)} 남음</div></div></div>`).join('')}</div></div>`;
            }).join('') : '';
            const myStatusCard = isCEO ? '' : `<div class="bg-white p-6 rounded-2xl shadow-sm border mb-8 flex justify-between items-center"><div class="absolute left-0 top-0 w-1.5 h-full bg-indigo-500"></div><div><h2 class="font-bold text-lg">내 연차 현황</h2><p class="text-sm text-gray-500">${app.currentUser.role.toUpperCase()}</p></div><div class="text-3xl font-bold text-indigo-600">${app.fmtTime(app.currentUser.totalHours-app.currentUser.usedHours)} <span class="text-lg text-gray-400 font-normal">/ ${app.fmtTime(app.currentUser.totalHours)}</span></div></div>`;
            document.getElementById('app-container').innerHTML = `<div class="w-full max-w-7xl mx-auto px-4 fade-in"><div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold">${isM?'시스템 최고 관리자':'관리자'} 대시보드</h2></div>${myStatusCard}<div class="mb-8">${app.renderCal(appData.requests, app.currentUser)}</div><div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8"><div class="bg-white rounded-xl shadow-sm border p-5"><div class="flex justify-between items-center mb-4"><h3 class="font-bold text-indigo-800 flex items-center"><i class="fa-regular fa-clock mr-2"></i> 결재 대기</h3><button onclick="app.approveAll('pending')" class="text-xs bg-indigo-600 text-white px-3 py-1.5 rounded hover:bg-indigo-700 font-bold transition">모두 승인</button></div><div class="space-y-3">${pendings.filter(r=>r.status==='pending').map(r=> { const displayType = (r.type === '시간차') ? '조퇴' : r.type; return `<div class="border p-4 rounded-lg flex justify-between items-center"><div><span class="font-bold">${r.userName}</span> <span class="text-xs text-gray-500">${r.dept}</span><div class="text-sm text-indigo-600 font-bold mt-1">${displayType} | ${r.reason}</div><div class="text-xs text-gray-400 mt-1">${r.startDate===r.endDate?app.fmtDate(r.startDate):app.fmtDate(r.startDate)+'~'+app.fmtDate(r.endDate)}</div></div><div class="flex flex-col gap-1"><button onclick="app.processReq(${r.id},'approve')" class="bg-indigo-600 text-white px-3 py-1.5 rounded text-xs font-bold">승인</button><button onclick="app.processReq(${r.id},'reject')" class="bg-gray-100 text-gray-600 px-3 py-1.5 rounded text-xs">반려</button></div></div>`; }).join('') || '<div class="text-center text-gray-400 py-4">대기 없음</div>'}</div></div><div class="bg-white rounded-xl shadow-sm border p-5"><div class="flex justify-between items-center mb-4"><h3 class="font-bold text-red-600 flex items-center"><i class="fa-solid fa-triangle-exclamation mr-2"></i> 취소 요청</h3><button onclick="app.approveAll('cancel')" class="text-xs bg-red-600 text-white px-3 py-1.5 rounded hover:bg-red-700 font-bold transition">모두 승인</button></div><div class="space-y-3">${pendings.filter(r=>r.status==='cancel_requested').map(r=>`<div class="border border-red-50 bg-red-50/30 p-4 rounded-lg flex justify-between items-center"><div><span class="font-bold">${r.userName}</span><div class="text-xs text-red-500 font-bold mt-1">취소 요청됨</div><div class="text-xs text-gray-400">${app.fmtDate(r.startDate)}</div></div><div class="flex flex-col gap-1"><button onclick="app.processReq(${r.id},'cancel_approve')" class="bg-red-600 text-white px-3 py-1.5 rounded text-xs font-bold">취소 승인</button><button onclick="app.processReq(${r.id},'cancel_reject')" class="bg-white border px-3 py-1.5 rounded text-xs">반려</button></div></div>`).join('') || '<div class="text-center text-gray-400 py-4">요청 없음</div>'}</div></div></div>${memberStatusHtml}</div>${app.getModal()}`;
            app.initModal();
        },
        renderUserManagement: () => {
            const list = app.currentUser.role === 'manager' ? appData.users.filter(u => u.dept === app.currentUser.dept) : appData.users;
            document.getElementById('app-container').innerHTML = `<div class="w-full max-w-5xl mx-auto px-4 pt-8 fade-in"><button onclick="app.refreshDashboard()" class="mb-6 bg-white border border-gray-300 px-4 py-2 rounded-lg font-bold hover:bg-gray-50 transition flex items-center text-sm"><i class="fa-solid fa-arrow-left mr-2"></i> 돌아가기</button><div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 mb-8"><h3 class="font-bold text-lg mb-4 text-gray-800">새 직원 등록</h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3 mb-4"><input id="new-name" placeholder="이름" class="border bg-gray-50 p-2.5 rounded"><select id="new-dept" class="border bg-gray-50 p-2.5 rounded"><option value="매뉴얼팀">매뉴얼팀</option><option value="파츠북팀">파츠북팀</option></select><input id="new-id" placeholder="ID" class="border bg-gray-50 p-2.5 rounded"><input id="new-pw" placeholder="비번" value="1" class="border bg-gray-50 p-2.5 rounded"><select id="new-role" class="border bg-gray-50 p-2.5 rounded"><option value="employee">일반 직원</option><option value="manager">팀장</option>${app.currentUser.role==='master'?'<option value="ceo">대표/임원</option>':''}</select><select id="new-rank" class="border bg-gray-50 p-2.5 rounded"><option value="사원">사원</option><option value="대리">대리</option><option value="과장">과장</option><option value="차장">차장</option><option value="부장">부장</option><option value="팀장">팀장</option></select><input id="new-days" type="number" value="15" class="border bg-gray-50 p-2.5 rounded" placeholder="연차일수"><input id="new-email" placeholder="이메일 주소" class="border bg-gray-50 p-2.5 rounded"></div><button onclick="app.addUser()" class="w-full bg-indigo-600 text-white px-4 py-3 rounded-lg font-bold hover:bg-indigo-700 transition shadow-md">등록하기</button></div><div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden"><table class="w-full text-left"><thead class="bg-gray-50 border-b border-gray-200"><tr><th class="p-4 text-sm font-bold text-gray-500">이름</th><th class="p-4 text-sm font-bold text-gray-500">부서</th><th class="p-4 text-sm font-bold text-gray-500">직급</th><th class="p-4 text-sm font-bold text-gray-500">ID</th><th class="p-4 text-sm font-bold text-gray-500">이메일</th><th class="p-4 text-sm font-bold text-gray-500 text-center">총 연차(일)</th>${app.currentUser.role==='master' ? '<th class="p-4 text-sm font-bold text-gray-500 text-center">비밀번호</th>' : ''}<th class="p-4 text-sm font-bold text-gray-500 text-right">관리</th></tr></thead><tbody class="divide-y divide-gray-100">${list.map(u => { const isEditing = String(app.editingId) === String(u.id); return `<tr class="hover:bg-gray-50 transition"><td class="p-4">${isEditing ? `<input id="n-${u.id}" value="${u.name}" class="border-b border-indigo-500 bg-transparent w-20 p-1 outline-none">` : `<span class="font-medium">${u.name}</span>`}</td><td class="p-4 text-sm text-gray-600">${u.dept}</td><td class="p-4 text-sm text-gray-600">${isEditing ? `<select id="r-${u.id}" class="bg-transparent border-b border-indigo-500 text-xs"><option value="사원" ${u.rank==='사원'?'selected':''}>사원</option><option value="대리" ${u.rank==='대리'?'selected':''}>대리</option><option value="과장" ${u.rank==='과장'?'selected':''}>과장</option><option value="차장" ${u.rank==='차장'?'selected':''}>차장</option><option value="부장" ${u.rank==='부장'?'selected':''}>부장</option><option value="팀장" ${u.rank==='팀장'?'selected':''}>팀장</option><option value="관리자" ${u.rank==='관리자'?'selected':''}>관리자</option><option value="대표" ${u.rank==='대표'?'selected':''}>대표</option></select>` : u.rank}</td><td class="p-4 text-sm text-gray-400 text-xs">${u.id}</td><td class="p-4 text-sm text-gray-600">${isEditing ? `<input id="e-${u.id}" value="${u.email||''}" class="border-b border-indigo-500 bg-transparent w-32 p-1 outline-none text-xs">` : (u.email||'-')}</td><td class="p-4 text-center">${isEditing ? `<input id="d-${u.id}" value="${u.totalHours/8}" class="border border-indigo-500 rounded w-16 p-1 text-center text-sm outline-none">` : `<span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs font-bold">${u.totalHours/8}일</span>`}</td>${app.currentUser.role==='master' ? `<td class="p-4 text-center">${isEditing ? `<input id="p-${u.id}" placeholder="새 비번" class="border border-indigo-500 rounded w-24 p-1 text-xs text-center outline-none">` : '<span class="text-gray-300 text-xs">****</span>'}</td>` : ''}<td class="p-4 text-right space-x-1">${isEditing ? `<button onclick="app.updateUser('${u.id}')" class="bg-indigo-600 text-white px-3 py-1 rounded text-xs font-bold hover:bg-indigo-700">저장</button><button onclick="app.cancelEdit()" class="bg-gray-200 text-gray-600 px-3 py-1 rounded text-xs font-bold hover:bg-gray-300">취소</button>` : `<button onclick="app.setEditMode('${u.id}')" class="text-indigo-600 hover:bg-indigo-50 px-3 py-1 rounded text-xs font-bold border border-indigo-200">수정</button><button onclick="app.deleteUser('${u.id}')" class="text-red-600 hover:bg-red-50 px-3 py-1 rounded text-xs font-bold border border-red-200">삭제</button>`}</td></tr>` }).join('')}</tbody></table></div></div>${app.getModal()}`;
        },
        getModal: () => {
            const timeOpts = makeTimeOptions();
            return `<div id="req-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden flex justify-center items-center z-50 fade-in"><div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl transform scale-100"><div class="flex justify-between items-center mb-6 border-b pb-2"><h3 class="font-bold text-xl text-gray-800" id="req-modal-title">연차 신청</h3><div class="flex items-center"><label class="inline-flex items-center cursor-pointer"><input type="checkbox" id="allow-past" class="sr-only peer" onchange="app.togglePastDates()"><div class="relative w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-indigo-600"></div><span class="ms-2 text-xs font-medium text-gray-500">지난 날짜 선택</span></label></div></div><div class="space-y-4 mb-6"><div><label class="block text-xs font-bold text-gray-500 mb-1">종류</label><select id="req-type" class="w-full bg-gray-50 border p-2.5 rounded-lg" onchange="toggleInputs()"><option value="연차">연차</option><option value="반차">반차 (4시간)</option><option value="조퇴">조퇴 (1~7시간)</option><option value="외출">외출</option></select></div><div id="div-date-range"><div class="flex justify-between items-center mb-1"><label class="block text-xs font-bold text-gray-500">날짜</label><label class="inline-flex items-center cursor-pointer"><span class="mr-2 text-xs text-gray-500">기간 설정</span><input type="checkbox" id="is-multi-day" class="sr-only peer" onchange="toggleInputs()"><div class="relative w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-indigo-600"></div></label></div><div class="flex gap-2"><input type="date" id="req-start-date" onchange="toggleInputs()" class="w-full bg-gray-50 border p-2.5 rounded-lg"><input type="date" id="req-end-date" class="w-full bg-gray-50 border p-2.5 rounded-lg"></div></div><div id="div-timeoff" class="hidden bg-indigo-50 p-3 rounded-lg border border-indigo-100"><div class="flex gap-2 mb-2"><div class="w-1/2"><label class="text-xs font-bold text-indigo-700">사용 시간</label><select id="req-duration-timeoff" class="w-full border p-1 rounded mt-1"><option value="1">1시간</option><option value="2">2시간</option><option value="3">3시간</option><option value="4">4시간</option><option value="5">5시간</option><option value="6">6시간</option><option value="7">7시간</option></select></div><div class="w-1/2"><label class="text-xs font-bold text-indigo-700">퇴근 시간</label><select id="req-end-time-timeoff" class="w-full border p-1 rounded mt-1"><option value="18">18:00</option><option value="17">17:00</option><option value="16">16:00</option></select></div></div><p class="text-[10px] text-indigo-600">* 퇴근 시간을 기준으로 역산</p></div><div id="div-out" class="hidden bg-emerald-50 p-3 rounded-lg border border-emerald-100"><div class="flex gap-2"><div class="w-1/2"><label class="text-xs font-bold text-emerald-700">시작</label><select id="req-start-time-out" class="w-full border p-1 rounded mt-1">${timeOpts}</select></div><div class="w-1/2"><label class="text-xs font-bold text-emerald-700">종료</label><select id="req-end-time-out" class="w-full border p-1 rounded mt-1">${timeOpts}</select></div></div></div><div><label class="block text-xs font-bold text-gray-500 mb-1">사유</label><select id="req-reason" class="w-full bg-gray-50 border p-2.5 rounded-lg"><option value="Refresh">Refresh</option><option value="병원(본인)">병원(본인)</option><option value="병원(가족)">병원(가족)</option><option value="가사">가사</option><option value="은행">은행</option><option value="여행">여행</option><option value="건강검진(유급)">건강검진(유급)</option><option value="건강검진(무급)">건강검진(무급)</option></select></div></div><div class="flex justify-end gap-2"><button onclick="document.getElementById('req-modal').classList.add('hidden')" class="bg-gray-100 px-5 py-2.5 rounded-lg font-bold">취소</button><button onclick="app.submitRequest()" id="req-modal-btn" class="bg-indigo-600 text-white px-5 py-2.5 rounded-lg font-bold shadow-lg">신청하기</button></div></div></div><div id="pw-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden flex justify-center items-center z-50 fade-in"><div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl"><h3 class="font-bold text-xl mb-6 border-b pb-2">비밀번호 변경</h3><div class="space-y-4 mb-6"><div><label class="block text-xs font-bold text-gray-500 mb-1">현재 비번</label><input type="password" id="pw-current" class="w-full bg-gray-50 border p-3 rounded-lg"></div><div><label class="block text-xs font-bold text-gray-500 mb-1">새 비번</label><input type="password" id="pw-new" class="w-full bg-gray-50 border p-3 rounded-lg"></div><div><label class="block text-xs font-bold text-gray-500 mb-1">비번 확인</label><input type="password" id="pw-confirm" class="w-full bg-gray-50 border p-3 rounded-lg"></div></div><div class="flex justify-end gap-2"><button onclick="document.getElementById('pw-modal').classList.add('hidden')" class="bg-gray-100 px-5 py-2.5 rounded-lg font-bold">취소</button><button onclick="app.changePassword()" class="bg-indigo-600 text-white px-5 py-2.5 rounded-lg font-bold shadow-lg">변경</button></div></div></div>`;
        },
        initModal: () => {
            app.editingId = null; const today = moment().format('YYYY-MM-DD'); const s = document.getElementById('req-start-date'); const e = document.getElementById('req-end-date'); document.getElementById('req-modal-title').innerText = "연차 신청"; document.getElementById('req-modal-btn').innerText = "신청하기"; document.getElementById('req-type').value = "연차"; document.getElementById('req-reason').value = "Refresh"; const toggle = document.getElementById('allow-past'); if(toggle) toggle.checked = false; const multiToggle = document.getElementById('is-multi-day'); if(multiToggle) multiToggle.checked = false; if(s && e) { s.min = today; e.min = today; s.value = today; e.value = today; } toggleInputs();
        }
    };
    function toggleInputs() { const t = document.getElementById('req-type').value; const sDate = document.getElementById('req-start-date'); const eDate = document.getElementById('req-end-date'); const allowPast = document.getElementById('allow-past')?.checked || false; const isMultiDay = document.getElementById('is-multi-day'); if (t === '연차') { isMultiDay.disabled = false; isMultiDay.parentElement.style.opacity = '1'; if (isMultiDay.checked) { eDate.style.display = 'block'; eDate.min = allowPast ? '' : sDate.value; if (!allowPast && moment(eDate.value).isBefore(sDate.value)) eDate.value = sDate.value; } else { eDate.style.display = 'none'; eDate.value = sDate.value; } } else { isMultiDay.checked = false; isMultiDay.disabled = true; isMultiDay.parentElement.style.opacity = '0.5'; eDate.style.display = 'none'; eDate.value = sDate.value; } document.getElementById('div-timeoff').style.display = t==='조퇴'?'block':'none'; document.getElementById('div-out').style.display = t==='외출'?'block':'none'; }
    app.init();
</script>
</body>
</html>